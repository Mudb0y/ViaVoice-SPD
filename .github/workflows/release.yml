name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y \
            gcc-multilib \
            libc6-dev-i386 \
            libspeechd-dev \
            curl \
            binutils \
            rpm2cpio \
            cpio \
            make

      - name: Build bundle
        run: |
          chmod +x scripts/build-bundle.sh
          ./scripts/build-bundle.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: viavoice-tts-bundle
          path: dist/viavoice-tts-bundle.tar.gz

      - name: Get version
        id: version
        if: startsWith(github.ref, 'refs/tags/')
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          name: ViaVoice TTS ${{ steps.version.outputs.VERSION }}
          body: |
            ## ViaVoice TTS Speech-Dispatcher Module
            
            Self-contained bundle for IBM ViaVoice TTS 5.1.
            
            ### Installation
            
            ```bash
            tar -xzf viavoice-tts-bundle.tar.gz
            cd viavoice-bundle
            sudo ./install.sh
            ```
            
            ### Test
            
            ```bash
            spd-say -o viavoice "Hello world"
            ```
            
            ### Requirements
            
            - Linux (any distro)
            - speech-dispatcher installed
            
            No config editing needed - module is auto-detected when placed in the modules folder!
          files: |
            dist/viavoice-tts-bundle.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Optional: Test the bundle
  test:
    needs: build
    runs-on: ubuntu-22.04
    
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: viavoice-tts-bundle

      - name: Install speech-dispatcher
        run: |
          sudo apt-get update
          sudo apt-get install -y speech-dispatcher

      - name: Extract and verify bundle
        run: |
          tar -xzf viavoice-tts-bundle.tar.gz
          cd viavoice-bundle
          
          echo "=== Bundle contents ==="
          ls -la
          ls -la usr/lib/ | head -20
          ls -la usr/bin/
          
          echo "=== Checking library resolution ==="
          LD_LIBRARY_PATH=./usr/lib ./usr/lib/ld-linux.so.2 --list ./usr/bin/sd_viavoice.bin
          
          echo "=== Bundle verification passed ==="

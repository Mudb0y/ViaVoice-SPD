name: Build and Release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y \
            file \
            gcc-multilib \
            libc6-dev-i386 \
            libspeechd-dev \
            curl \
            binutils \
            rpm2cpio \
            cpio \
            make

      - name: Build bundle
        run: |
          chmod +x scripts/build-bundle.sh
          ./scripts/build-bundle.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: viavoice-tts-bundle
          path: dist/viavoice-tts-bundle.tar.gz

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: dist/viavoice-tts-bundle.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    needs: build
    runs-on: ubuntu-22.04
    
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: viavoice-tts-bundle

      - name: Install speech-dispatcher
        run: |
          sudo apt-get update
          sudo apt-get install -y speech-dispatcher

      - name: Extract and verify bundle
        run: |
          tar -xzf viavoice-tts-bundle.tar.gz
          cd viavoice-bundle
          
          echo "=== Bundle contents ==="
          ls -la
          ls -la usr/lib/ | head -20
          ls -la usr/bin/
          
          echo "=== Checking library resolution ==="
          LD_LIBRARY_PATH=./usr/lib ./usr/lib/ld-linux.so.2 --list ./usr/bin/sd_viavoice.bin
          
          echo "=== Bundle verification passed ==="
